SRC := src
SRC_FILES := $(wildcard $(SRC)/**/*.luau)

ROJO := rojo
SOURCEMAP_FILE := sourcemap.json

WALLY := wally
WALLY_INSTALLED := .wally-installed

WALLY_PACKAGE_TYPES := wally-package-types
WALLY_PACKAGES_FIXED := Packages/.wally-package-types-fixed
WALLY_SERVER_PACKAGES_FIXED := ServerPackages/.wally-package-types-fixed

.PHONY: wally-package-types wally-install clean

wally-package-types: $(WALLY_PACKAGES_FIXED) $(WALLY_SERVER_PACKAGES_FIXED)

$(WALLY_PACKAGES_FIXED): $(WALLY_INSTALLED) $(SOURCEMAP_FILE)
	$(WALLY_PACKAGE_TYPES) --sourcemap $(SOURCEMAP_FILE) Packages
	touch $@

$(WALLY_SERVER_PACKAGES_FIXED): $(WALLY_INSTALLED) $(SOURCEMAP_FILE)
	$(WALLY_PACKAGE_TYPES) --sourcemap $(SOURCEMAP_FILE) ServerPackages
	touch $@

wally-install: $(WALLY_INSTALLED)

$(WALLY_INSTALLED): wally.toml
	$(WALLY) install
	touch $@

$(SOURCEMAP_FILE): $(SRC_FILES) | $(WALLY_INSTALLED)
	$(ROJO) sourcemap --output $(SOURCEMAP_FILE)
	touch $@

clean:
	$(RM) -f $(SOURCEMAP_FILE)
	$(RM) -rf $(WALLY_INSTALLED)
	$(RM) -rf $(WALLY_PACKAGES_FIXED)
	$(RM) -rf $(WALLY_SERVER_PACKAGES_FIXED)
	$(RM) -rf Packages
	$(RM) -rf ServerPackages

# Documentation
include docs.mk
